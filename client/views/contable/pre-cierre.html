<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pre-Cierre Fiscal - Super Contable</title>
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/contable.css">
  <link rel="stylesheet" href="/assets/css/pre-cierre.css">
</head>
<body>
  <div class="dashboard">
    
    <!-- NAVBAR -->
    <nav class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">üìä Super Contable - Pre-Cierre Fiscal</div>
        <div class="navbar-user">
          <div>
            <div class="navbar-user-name" id="userName">Cargando...</div>
            <span class="navbar-user-role">Contable</span>
          </div>
          <button class="btn btn-sm btn-outline" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </nav>

    <!-- TABS -->
    <div class="tabs-container">
      <nav class="tabs">
        <a href="dashboard.html" class="tab">üìä Dashboard</a>
        <a href="empresas.html" class="tab">üè¢ Empresas</a>
        <a href="asistentes.html" class="tab">üë• Asistentes</a>
        <a href="facturas.html" class="tab">üìã Facturas</a>
        <a href="pre-cierre.html" class="tab active">üéØ Pre-Cierre</a>
      </nav>
    </div>

    <!-- HEADER CON CONTROLES -->
    <div class="pre-cierre-header">
      <div class="header-left">
        <h1>Pre-Cierre Fiscal</h1>
        
        <!-- Selector de Vista -->
        <div class="view-selector" style="display: flex; background: #f1f5f9; padding: 4px; border-radius: 6px; margin-left: 1rem; border: 1px solid #e2e8f0;">
          <button id="btnViewPendientes" class="btn-view active" onclick="cambiarVista('aprobada')" style="border:none; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; background: white; color: #0f172a; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
            üìÇ Pendientes
          </button>
          <button id="btnViewHistorico" class="btn-view" onclick="cambiarVista('exportada')" style="border:none; padding: 6px 12px; border-radius: 4px; font-size: 0.85rem; font-weight: 600; cursor: pointer; color: #64748b; background: transparent; transition: all 0.2s;">
            üìú Hist√≥rico
          </button>
        </div>

        <div class="periodo-selector">
          <label>Per√≠odo:</label>
          <select id="periodoMes" class="input-inline">
            <option value="01">Enero</option>
            <option value="02">Febrero</option>
            <option value="03">Marzo</option>
            <option value="04">Abril</option>
            <option value="05">Mayo</option>
            <option value="06">Junio</option>
            <option value="07">Julio</option>
            <option value="08">Agosto</option>
            <option value="09">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12" selected>Diciembre</option>
          </select>
          <select id="periodoAnio" class="input-inline">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
        </div>
      </div>
      <div class="header-actions" id="exportButtonsContainer">
        <!-- BOTONES DE EXPORTACI√ìN (SHEETS Y EXCEL) -->
        <button class="btn btn-success" onclick="abrirModalExportar('sheets')" style="background-color: #10b981; border-color: #10b981; display: flex; align-items: center; gap: 6px;">
          üìä Sheets
        </button>
        <button class="btn btn-primary" onclick="abrirModalExportar('csv')" style="display: flex; align-items: center; gap: 6px;">
          üì• Excel
        </button>
      </div>
    </div>

    <!-- TABLA TIPO EXCEL -->
    <div class="table-container-excel">
      <table class="table-excel" id="preCierreTable">
        <thead>
          <tr>
            <th width="30" title="Anomal√≠as"></th>
            <th width="100">Fecha</th>
            <th width="150">
              Empresa
              <select class="header-filter" id="filterEmpresa" onchange="aplicarFiltros()">
                <option value="">Todas</option>
              </select>
            </th>
            <th width="110">
              RNC
              <input type="text" class="header-filter" id="filterRNC" placeholder="Buscar..." onkeyup="aplicarFiltros()">
            </th>
            <th width="60">
              Tipo
              <select class="header-filter" id="filterTipo" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                <option value="B01">B01</option>
                <option value="B02">B02</option>
                <option value="B11">B11</option>
                <option value="B14">B14</option>
                <option value="B15">B15</option>
              </select>
            </th>
            <th width="150">
              NCF
              <input type="text" class="header-filter" id="filterNCF" placeholder="Buscar NCF..." onkeyup="aplicarFiltros()">
            </th>
            <th width="200">
              Proveedor
              <input type="text" class="header-filter" id="filterProveedor" placeholder="Buscar..." onkeyup="aplicarFiltros()">
            </th>
            <th width="200">
              Tipo de Gasto
              <select class="header-filter" id="filterGasto" onchange="aplicarFiltros()">
                <option value="">Todos</option>
                <option value="VACIO">‚ö†Ô∏è Sin Clasificar</option>
                <option value="E01">E01 - Personal</option>
                <option value="E02">E02 - Servicios</option>
                <option value="E03">E03 - Arrendamientos</option>
                <option value="E04">E04 - Activos Fijos</option>
                <option value="E05">E05 - Representaci√≥n</option>
                <option value="E06">E06 - Deducciones</option>
                <option value="E07">E07 - Financieros</option>
                <option value="E08">E08 - Extraordinarios</option>
                <option value="E09">E09 - Costo Venta</option>
                <option value="E10">E10 - Adq. Activos</option>
                <option value="E11">E11 - Seguros</option>
              </select>
            </th>
            <th width="140">
              Forma de Pago
              <select class="header-filter" id="filterPago" onchange="aplicarFiltros()">
                <option value="">Todas</option>
                <option value="VACIO">‚ö†Ô∏è Sin Clasificar</option>
                <option value="01">Efectivo</option>
                <option value="02">Cheque</option>
                <option value="03">Transferencia</option>
                <option value="04">T. Cr√©dito</option>
                <option value="05">T. D√©bito</option>
                <option value="06">Cr√©dito</option>
              </select>
            </th>
            <th width="100" class="text-right">ITBIS</th>
            <th width="120" class="text-right">Total</th>
          </tr>
        </thead>
        <tbody id="preCierreTableBody">
          <tr>
            <td colspan="11" class="text-center">Cargando facturas aprobadas...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- BARRA DE ESTADO -->
    <div class="status-bar">
      <div class="status-item">
        <span id="statusTotal">0 facturas</span>
      </div>
      <div class="status-item anomalia" id="statusDuplicados" style="display: none;">
        üî¥ <span id="countDuplicados">0</span> duplicados
      </div>
      <div class="status-item warning" id="statusSospechosas" style="display: none;">
        üü° <span id="countSospechosas">0</span> sospechosas
      </div>
      <div class="status-item warning" id="statusFueraPeriodo" style="display: none;">
        üü† <span id="countFueraPeriodo">0</span> fuera per√≠odo
      </div>
      <div class="status-item warning" id="statusRNCInvalido" style="display: none;">
        üî∂ <span id="countRNCInvalido">0</span> RNC inv√°lido
      </div>
      <div class="status-item warning" id="statusITBIS" style="display: none;">
        üßæ <span id="countITBIS">0</span> ITBIS=0
      </div>
      <div class="status-item warning" id="statusSinClasificar" style="display: none;">
        ‚ö†Ô∏è <span id="countSinClasificar">0</span> sin clasificar
      </div>
      <div class="status-item success">
        ‚úÖ <span id="statusOK">0</span> OK
      </div>
    </div>

  </div>

  <!-- MODAL DE EXPORTACI√ìN -->
  <div id="exportModal" class="modal-duplicados">
    <div class="modal-duplicados-content" style="max-width: 500px;">
      <div class="modal-duplicados-header">
        <h3>üì§ Exportar Datos</h3>
        <button class="modal-close" onclick="cerrarModalExportar()">√ó</button>
      </div>
      <div class="modal-duplicados-body" style="display: block;">
        
        <!-- Selecci√≥n de Empresa -->
        <div style="margin-bottom: 1.5rem;">
          <label style="display:block; font-weight:600; margin-bottom:0.5rem; color:#1e293b;">1. Selecciona la Empresa:</label>
          <select id="exportEmpresaSelect" class="input-inline" style="width: 100%; padding: 0.6rem;">
            <option value="TODAS">üì¶ Todas las Empresas (Archivo Unificado)</option>
          </select>
        </div>

        <!-- Selecci√≥n de Columnas -->
        <div>
          <label style="display:block; font-weight:600; margin-bottom:0.5rem; color:#1e293b;">2. Selecciona las columnas:</label>
          <div class="columns-grid">
            <!-- Se llena din√°micamente con JS -->
          </div>
        </div>

        <!-- Opciones de Cierre / Limpieza -->
        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
          <label style="display:flex; align-items:flex-start; gap:0.5rem; cursor:pointer; background: #fffbeb; padding: 0.75rem; border-radius: 6px; border: 1px solid #fef3c7;">
            <input type="checkbox" id="checkArchivar" style="width:1.2rem; height:1.2rem; margin-top:0.2rem;" checked>
            <div>
              <span style="font-weight:700; color:#92400e; display:block;">üßπ Limpiar mesa de trabajo</span>
              <span style="font-size:0.85rem; color:#b45309; display:block; margin-top:0.25rem;">
                Marcar facturas exportadas como "Procesadas" y ocultarlas de esta lista.
              </span>
            </div>
          </label>
        </div>

      </div>
      <div class="modal-duplicados-footer">
        <button class="btn btn-outline" onclick="cerrarModalExportar()">Cancelar</button>
        <!-- BOT√ìN EXCEL (Visible por defecto) -->
        <button class="btn btn-primary" id="btnExportarCSV" onclick="ejecutarExportacion()">üì• Descargar y Procesar</button>
        <!-- BOT√ìN SHEETS (Oculto por defecto) -->
        <button class="btn btn-success" id="btnExportarSheets" onclick="ejecutarExportacionSheets()" style="display: none; background-color: #10b981; border-color: #10b981;">üìä Exportar a Google Sheets</button>
      </div>
    </div>
  </div>

  <!-- ‚úÖ MODAL DE CONFIRMACI√ìN PARA "TODAS" -->
  <div id="confirmTodasModal" class="modal-overlay" style="display: none;">
    <div class="modal-content modal-warning">
      <div class="modal-header-warning">
        <span style="font-size: 2rem;">‚ö†Ô∏è</span>
        <h3>CONFIRMA EXPORTACI√ìN A "TODAS"</h3>
      </div>
      
      <div class="modal-body">
        <div class="info-box">
          <strong>üì¶ Archivo destino:</strong><br>
          "Super Contable - TODAS"
        </div>
        
        <div class="info-box">
          <strong>üìä Facturas a exportar:</strong> <span id="todasFacturasCount">0</span>
        </div>
        
        <div class="warning-box">
          ‚ö†Ô∏è Este archivo es compartido y se actualizar√° en Google Drive
        </div>
        
        <label class="checkbox-confirm">
          <input type="checkbox" id="checkConfirmTodas">
          <span>Confirmo que revis√© el filtro y quiero exportar a TODAS</span>
        </label>
      </div>
      
      <div class="modal-footer">
        <button class="btn-secondary" onclick="cerrarModalConfirmTodas()">
          Cancelar
        </button>
        <button id="btnConfirmarTodas" class="btn-primary" disabled onclick="confirmarExportTodas()">
          Exportar TODAS
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL DE DUPLICADOS -->
  <div id="duplicadosModal" class="modal-duplicados">
    <div class="modal-duplicados-content">
      <div class="modal-duplicados-header">
        <h3>‚ö†Ô∏è COMPARACI√ìN DE DUPLICADOS</h3>
        <button class="modal-close" onclick="cerrarModalDuplicados()">√ó</button>
      </div>
      
      <div class="modal-duplicados-body">
        
        <!-- FACTURA 1 -->
        <div class="factura-comparacion">
          <div class="factura-comparacion-header">
            <h4 id="factura1Title">FACTURA A</h4>
          </div>
          <div class="factura-comparacion-content">
            <div class="comparacion-imagen">
              <img id="factura1Imagen" src="" alt="Factura A">
            </div>
            <div class="comparacion-datos">
              <div class="dato-row"><span class="dato-label">Fecha:</span><span id="factura1Fecha" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">NCF:</span><span id="factura1NCF" class="dato-value highlight-danger">--</span></div>
              <div class="dato-row"><span class="dato-label">Monto:</span><span id="factura1Total" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">Proveedor:</span><span id="factura1Proveedor" class="dato-value">--</span></div>
            </div>
          </div>
          <button class="btn btn-danger btn-block" id="btnEliminar1">üóëÔ∏è Eliminar</button>
        </div>

        <!-- FACTURA 2 -->
        <div class="factura-comparacion">
          <div class="factura-comparacion-header">
            <h4 id="factura2Title">FACTURA B</h4>
          </div>
          <div class="factura-comparacion-content">
            <div class="comparacion-imagen">
              <img id="factura2Imagen" src="" alt="Factura B">
            </div>
            <div class="comparacion-datos">
              <div class="dato-row"><span class="dato-label">Fecha:</span><span id="factura2Fecha" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">NCF:</span><span id="factura2NCF" class="dato-value highlight-danger">--</span></div>
              <div class="dato-row"><span class="dato-label">Monto:</span><span id="factura2Total" class="detail-value">--</span></div>
              <div class="dato-row"><span class="dato-label">Proveedor:</span><span id="factura2Proveedor" class="dato-value">--</span></div>
            </div>
          </div>
          <button class="btn btn-danger btn-block" id="btnEliminar2">üóëÔ∏è Eliminar</button>
        </div>

      </div>

      <div class="modal-duplicados-footer">
        <span style="margin-right:auto; color:#64748b; font-size:0.85rem;">üî¥ El sistema detect√≥ el mismo NCF en ambas.</span>
        <button class="btn btn-outline" onclick="cerrarModalDuplicados()">Cancelar</button>
        <button class="btn btn-primary" onclick="mantenerAmbasDuplicadas()">‚úÖ Ignorar y Mantener Ambas</button>
      </div>
    </div>
  </div>

  <!-- MODAL SOSPECHOSAS -->
  <div id="sospechosasModal" class="modal-duplicados">
    <div class="modal-duplicados-content">
      <div class="modal-duplicados-header" style="border-bottom: 2px solid #fcd34d;">
        <h3 style="color: #b45309;">üü° COMPARACI√ìN DE SOSPECHOSAS</h3>
        <button class="modal-close" onclick="cerrarModalSospechosas()">√ó</button>
      </div>
      
      <div class="modal-duplicados-body">
        
        <!-- FACTURA 1 -->
        <div class="factura-comparacion">
          <div class="factura-comparacion-header">
            <h4 id="sospechosa1Title">FACTURA A</h4>
          </div>
          <div class="factura-comparacion-content">
            <div class="comparacion-imagen">
              <img id="sospechosa1Imagen" src="" alt="Factura A">
            </div>
            <div class="comparacion-datos">
              <div class="dato-row"><span class="dato-label">Fecha:</span><span id="sospechosa1Fecha" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">NCF:</span><span id="sospechosa1NCF" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">Monto:</span><span id="sospechosa1Total" class="dato-value highlight-danger">--</span></div>
              <div class="dato-row"><span class="dato-label">Proveedor:</span><span id="sospechosa1Proveedor" class="dato-value">--</span></div>
            </div>
          </div>
          <button class="btn btn-danger btn-block" id="btnEliminarSosp1">üóëÔ∏è Eliminar</button>
        </div>

        <!-- FACTURA 2 -->
        <div class="factura-comparacion">
          <div class="factura-comparacion-header">
            <h4 id="sospechosa2Title">FACTURA B</h4>
          </div>
          <div class="factura-comparacion-content">
            <div class="comparacion-imagen">
              <img id="sospechosa2Imagen" src="" alt="Factura B">
            </div>
            <div class="comparacion-datos">
              <div class="dato-row"><span class="dato-label">Fecha:</span><span id="sospechosa2Fecha" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">NCF:</span><span id="sospechosa2NCF" class="dato-value">--</span></div>
              <div class="dato-row"><span class="dato-label">Monto:</span><span id="sospechosa2Total" class="dato-value highlight-danger">--</span></div>
              <div class="dato-row"><span class="dato-label">Proveedor:</span><span id="sospechosa2Proveedor" class="dato-value">--</span></div>
            </div>
          </div>
          <button class="btn btn-danger btn-block" id="btnEliminarSosp2">üóëÔ∏è Eliminar</button>
        </div>
      </div>

      <div class="modal-duplicados-footer">
        <span style="margin-right:auto; color:#b45309; font-size:0.85rem;">üü° Mismo proveedor, fecha y monto. ¬øDoble cobro?</span>
        <button class="btn btn-outline" onclick="marcarComoRevisadas()">‚úì Marcar como Revisadas</button>
        <button class="btn btn-primary" onclick="mantenerAmbas()">‚úÖ Son Compras Diferentes</button>
      </div>
    </div>
  </div>

  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/pre-cierre.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const user = getUser();
      if (user) document.getElementById('userName').textContent = user.nombre_completo;
    });
  </script>
</body>
</html>