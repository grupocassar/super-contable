<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Super Contable</title>
  <link rel="stylesheet" href="/assets/css/global.css">
  <link rel="stylesheet" href="/assets/css/contable.css">
</head>
<body>
  <div class="dashboard">
    <nav class="navbar">
      <div class="navbar-content">
        <div class="navbar-brand">üìä Super Contable</div>
        <div class="navbar-user">
          <div>
            <div class="navbar-user-name" id="userName">Cargando...</div>
            <span class="navbar-user-role">Contable</span>
          </div>
          <button class="btn btn-sm btn-outline" id="logoutBtn">Cerrar Sesi√≥n</button>
        </div>
      </div>
    </nav>

    <div class="tabs-container">
      <nav class="tabs">
        <a href="dashboard.html" class="tab active">üìä Dashboard</a>
        <a href="empresas.html" class="tab">üè¢ Empresas</a>
        <a href="asistentes.html" class="tab">üë• Asistentes</a>
        <a href="facturas.html" class="tab">üìã Facturas</a>
        <a href="pre-cierre.html" class="tab">üéØ Pre-Cierre</a>
      </nav>
    </div>

    <!-- HEADER CON BOT√ìN DRIVE -->
    <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
      <div>
        <h1>Panel General</h1>
        <p>Bienvenido. Aqu√≠ tienes el resumen de las operaciones de hoy.</p>
      </div>
      <div>
          <!-- Bot√≥n de Conexi√≥n -->
          <button id="btnConnectDrive" class="btn btn-primary" onclick="initDriveConnection()" style="background-color: #4285F4; border-color: #4285F4; display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="fill: white;"><path d="M12.01 1.996c-1.287 0-2.524.364-3.568 1.054L2.83 13.06l-.01.01c-.347.606-.525 1.282-.525 1.986 0 2.204 1.796 4 4 4h2.24l-3.32-5.75L10.74 3.96c.407-.235.867-.364 1.345-.364h7.032l-3.692 6.4h-5.69L5.84 16.74c.642.793 1.63 1.306 2.74 1.306h9.67c2.204 0 4-1.796 4-4 0-1.29-.61-2.434-1.553-3.174l-6.99-12.11c-.563-.482-1.28-.766-2.062-.766zM13.7 9.996h5.69l3.43 5.94c.33-.526.524-1.15.524-1.816 0-1.292-.72-2.408-1.785-3.004l-7.86-13.62L13.7 9.996z"/></svg>
            Conectar Google Drive
          </button>
          <!-- Badge Conectado (Oculto por defecto) -->
          <div id="driveConnectedBadge" style="display: none; align-items: center; gap: 6px; color: #16a34a; font-weight: 600; background: #dcfce7; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #bbf7d0;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>
            Drive Conectado
          </div>
      </div>
    </div>

    <!-- NUEVO WIDGET: PLAN Y CONSUMO (Aqu√≠ se renderiza el JS) -->
    <div id="plan-consumo-widget"></div>

    <!-- SOLO ESTAD√çSTICAS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üè¢</div>
        <div class="stat-label">Empresas</div>
        <div class="stat-value" id="totalEmpresas">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üë®‚Äçüíº</div>
        <div class="stat-label">Asistentes</div>
        <div class="stat-value" id="totalAsistentes">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-label">Pendientes</div>
        <div class="stat-value" id="facturasPendientes">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-label">Aprobadas</div>
        <div class="stat-value" id="facturasAprobadas">0</div>
      </div>
    </div>

    <!-- ACCESOS R√ÅPIDOS -->
    <div class="content-section">
      <div class="section-header">
        <h2 class="section-title">Accesos R√°pidos</h2>
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <a href="empresas.html" class="stat-card" style="text-decoration: none; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
          <div class="stat-icon">üè¢</div>
          <div class="stat-label">Gestionar Empresas</div>
          <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Alta, edici√≥n y consulta de clientes
          </p>
        </a>
        
        <a href="asistentes.html" class="stat-card" style="text-decoration: none; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
          <div class="stat-icon">üë•</div>
          <div class="stat-label">Gestionar Asistentes</div>
          <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Asignaci√≥n de empresas y permisos
          </p>
        </a>
        
        <a href="facturas.html" class="stat-card" style="text-decoration: none; cursor: pointer; border: 2px solid transparent; transition: all 0.2s;">
          <div class="stat-icon">üìã</div>
          <div class="stat-label">Historial de Facturas</div>
          <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Consulta, validaci√≥n y exportaci√≥n
          </p>
        </a>

        <a href="pre-cierre.html" class="stat-card" style="text-decoration: none; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; border-color: var(--primary-color);">
          <div class="stat-icon">üéØ</div>
          <div class="stat-label">Pre-Cierre Fiscal</div>
          <p style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Clasificaci√≥n, auditor√≠a y export 606
          </p>
        </a>
      </div>
    </div>

  </div>

  <script src="/assets/js/utils.js"></script>
  <script src="/assets/js/contable.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // 1. Carga inicial r√°pida (datos locales)
      const localUser = getUser();
      if (localUser) {
         document.getElementById('userName').textContent = localUser.nombre_completo;
         // Si localmente dice que est√° conectado, mostrarlo de una vez
         if (localUser.drive_connected) toggleDriveStatus(true);
      }

      // 2. Verificaci√≥n de estado real (datos frescos del servidor)
      try {
        const response = await fetchAPI('/auth/verify');
        if (response.success && response.user) {
            const freshUser = response.user;
            
            // Actualizar localStorage con el dato fresco
            const updatedUser = { ...localUser, ...freshUser };
            localStorage.setItem('user', JSON.stringify(updatedUser));

            // Actualizar UI
            toggleDriveStatus(freshUser.drive_connected);
        }
      } catch (error) {
        console.error("Error verificando estado de Drive:", error);
      }

      // 3. Manejar retorno de Google (Callback visual)
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('drive') === 'success') {
          showToast('‚úÖ Google Drive conectado correctamente', 'success');
          // Limpiar URL para que no salga el mensaje al recargar
          window.history.replaceState({}, document.title, window.location.pathname);
          toggleDriveStatus(true);
      } else if (urlParams.get('drive') && urlParams.get('drive').includes('error')) {
          showToast('‚ùå Error al conectar Drive', 'error');
      }
    });

    async function initDriveConnection() {
        try {
            const response = await fetchAPI('/auth/google/connect');
            if (response.success && response.url) {
                // Redirigir a Google
                window.location.href = response.url;
            } else {
                showToast('Error al iniciar conexi√≥n', 'error');
            }
        } catch (error) {
            console.error(error);
            showToast('Error de conexi√≥n', 'error');
        }
    }

    function toggleDriveStatus(connected) {
        const btn = document.getElementById('btnConnectDrive');
        const badge = document.getElementById('driveConnectedBadge');
        if (connected) {
            if(btn) btn.style.display = 'none';
            if(badge) badge.style.display = 'flex';
        } else {
            if(btn) btn.style.display = 'flex';
            if(badge) badge.style.display = 'none';
        }
    }
  </script>
</body>
</html>